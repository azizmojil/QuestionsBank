{% extends "base.html" %}
{% load static i18n %}

{% block title %}{% trans "منشئ الاستبيان - منصة QnR" %}{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'surveys/css/builder.css' %}">
{% endblock %}

{% block content %}
<section id="builder-workspace" class="builder-grid">
    <form id="builder-form">
        <label class="stacked">
            {% trans "اختر إصدار استبيان" %}
            <select id="survey-version-select">
                <option value="" disabled selected>{% trans "اختر إصدارًا لتحميله" %}</option>
                {% for version in survey_versions %}
                    <option value="{{ version.id }}">{{ version.label }}</option>
                {% endfor %}
            </select>
        </label>
        <div class="section-actions mt-3">
            <button type="button" class="btn" id="add-section-btn">{% trans "إضافة قسم" %}</button>
        </div>
        <div id="sections-container" class="section-container" aria-live="polite"></div>
    </form>
</section>

<template id="section-template">
    <div class="card section-block">
        <div class="section-head">
            <div class="stacked">
                <label>{% trans "عنوان القسم" %}
                    <input type="text" class="section-name" placeholder="{% trans 'عنوان القسم' %}">
                </label>
                <label>{% trans "وصف القسم" %}
                    <textarea class="section-description" rows="2" placeholder="{% trans 'صف بإيجاز ما يتضمنه هذا القسم' %}"></textarea>
                </label>
            </div>
            <div class="section-controls">
                <button type="button" class="btn btn-secondary remove-section">{% trans "حذف القسم" %}</button>
                <button type="button" class="btn add-question">{% trans "إضافة سؤال" %}</button>
                <button type="button" class="btn add-matrix-question">{% trans "إضافة سؤال مصفوفة" %}</button>
            </div>
        </div>
        <div class="questions-area">
            <div class="question-list"></div>
        </div>
    </div>
</template>

<template id="question-template">
    <div class="card question-block">
        <div class="question-grid">
            <label class="stacked">{% trans "السؤال" %}</label>
            <label class="stacked">{% trans "نوع الاستجابة" %}</label>
            <button type="button" class="btn btn-secondary remove-question">{% trans "حذف" %}</button>

            <select class="question-select" required>
                <option value="" disabled selected>{% trans "اختر سؤالاً من قاعدة البيانات" %}</option>
                {% for q in available_questions %}
                    <option value="{{ q.id }}">{{ q.label }}</option>
                {% empty %}
                    <option value="" disabled>{% trans "لا توجد أسئلة متاحة بعد" %}</option>
                {% endfor %}
            </select>

            <select class="response-type">
                {% for rt in response_types %}
                    <option value="{{ rt.value }}">{{ rt.label }}</option>
                {% endfor %}
            </select>

            <div></div> <!-- Empty cell for alignment -->

            <label class="stacked">{% trans "مجموعة الإجابات" %}</label>
            <label class="checkbox">
                <input type="checkbox" class="question-required">
                <span>{% trans "إلزامي" %}</span>
            </label>
            <div></div> <!-- Empty cell for alignment -->

            <select class="response-group">
                <option value="" disabled selected>{% trans "اختر مجموعة إجابات" %}</option>
                {% for rg in response_groups %}
                    <option value="{{ rg.value }}">{{ rg.label }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
</template>

<template id="matrix-question-template">
    <div class="card question-block matrix-question-block">
        <div class="question-grid">
            <label class="stacked">{% trans "أسئلة المصفوفة" %}</label>
            <label class="stacked">{% trans "نوع الاستجابة" %}</label>
            <button type="button" class="btn btn-secondary remove-question">{% trans "حذف" %}</button>

            <select class="matrix-question-select">
                <option value="" disabled selected>{% trans "أضف سؤالاً إلى المصفوفة" %}</option>
                {% for q in available_questions %}
                    <option value="{{ q.id }}">{{ q.label }}</option>
                {% endfor %}
            </select>

            <select class="response-type">
                {% for rt in response_types %}
                    <option value="{{ rt.value }}">{{ rt.label }}</option>
                {% endfor %}
            </select>

            <div></div> <!-- Empty cell for alignment -->

            <label class="stacked">{% trans "مجموعة المصفوفة" %}</label>
            <label class="checkbox">
                <input type="checkbox" class="question-required">
                <span>{% trans "إلزامي" %}</span>
            </label>
            <div></div> <!-- Empty cell for alignment -->

            <select class="matrix-group">
                <option value="" disabled selected>{% trans "اختر مجموعة مصفوفة" %}</option>
                {% for mg in matrix_item_groups %}
                    <option value="{{ mg.value }}">{{ mg.label }}</option>
                {% endfor %}
            </select>

            <div></div> <!-- Empty cell for alignment -->
            <div></div> <!-- Empty cell for alignment -->

            <label class="stacked">{% trans "مجموعة الإجابات" %}</label>
            <div></div> <!-- Empty cell for alignment -->
            <div></div> <!-- Empty cell for alignment -->

            <select class="response-group">
                <option value="" disabled selected>{% trans "اختر مجموعة إجابات" %}</option>
                {% for rg in response_groups %}
                    <option value="{{ rg.value }}">{{ rg.label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="selected-matrix-questions mt-2"></div>
    </div>
</template>

{{ response_types|json_script:"response-types-data" }}
{{ available_questions|json_script:"available-questions-data" }}
{{ response_groups|json_script:"response-groups-data" }}
{{ matrix_item_groups|json_script:"matrix-item-groups-data" }}
{{ survey_structures|json_script:"survey-structures-data" }}
<script id="builder-locale" type="application/json">
    {
        "yes": "{% trans 'نعم' %}",
        "no": "{% trans 'لا' %}",
        "untitled": "{% trans 'استبيان بدون عنوان' %}"
    }
</script>
{% endblock %}

{% block extra_js %}
    <script src="{% static 'surveys/js/builder.js' %}"></script>
{% endblock %}
