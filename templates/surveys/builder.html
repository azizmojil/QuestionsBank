{% extends "base.html" %}
{% load static i18n %}

{% block title %}{% trans "منشئ الاستبيان - منصة QnR" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'surveys/css/builder.css' %}">
{% endblock %}

{% block content %}
<section class="stage-nav card">
    <div class="workflow-head">
        <h1 class="page-title">{% trans "منشئ الاستبيان" %}</h1>
    </div>
    <div class="stage-tabs" role="tablist">
        <a href="{% url 'survey_builder_initial_root' %}" class="stage-tab" role="tab" aria-selected="false">{% trans "القائمة المبدئية" %}</a>
        <button class="stage-tab" data-stage-target="final" role="tab" aria-selected="true">{% trans "البناء النهائي" %}</button>
        <button class="stage-tab" data-stage-target="routing" role="tab" aria-selected="false">{% trans "قواعد التوجيه" %}</button>
        <button class="stage-tab" data-stage-target="business" role="tab" aria-selected="false">{% trans "قواعد الأعمال" %}</button>
    </div>
</section>

<section id="builder-workspace" class="builder-grid builder-columns stage-panel" data-stage="final" aria-label="{% trans 'البناء النهائي' %}">
    <div class="card">
        <div class="section-head">
            <div>
                <h2 class="card-title">{% trans "البناء النهائي للاستبيان" %}</h2>
                <p class="muted">{% trans "رتب الأقسام والأسئلة النهائية، ويمكنك إعادة ترتيبها بالسحب والإفلات." %}</p>
            </div>
            <div class="section-actions">
                <button type="button" class="btn btn-secondary" id="add-section-btn">{% trans "إضافة قسم" %}</button>
            </div>
        </div>
        <form id="builder-form">
            <div id="sections-container" class="section-container" aria-live="polite"></div>
        </form>
        <div class="stage-actions">
            <a href="{% url 'survey_builder_initial_root' %}" class="btn btn-secondary prev-stage">{% trans "السابق" %}</a>
            <button type="button" class="btn next-stage" data-next-stage="routing">{% trans "التالي: قواعد التوجيه" %}</button>
        </div>
    </div>
</section>

<section class="builder-grid stage-panel hidden" data-stage="routing" aria-label="{% trans 'قواعد التوجيه' %}">
    <div class="card rules-card">
        <div class="section-head">
            <div>
                <h2 class="card-title">{% trans "قواعد التوجيه" %}</h2>
                <p class="muted">{% trans "اسحب الأسئلة إلى مناطق القواعد لتحديد الانتقال." %}</p>
            </div>
        </div>
        <div class="rule-palette" id="question-palette" aria-label="{% trans 'الأسئلة المتاحة للقواعد' %}"></div>
        <div class="rules-grid">
            <div class="rule-stack">
                <h3>{% trans "شروط التوجيه" %}</h3>
                <div class="dropzone" id="routing-conditions" aria-label="{% trans 'شروط التوجيه' %}"></div>
            </div>
            <div class="rule-stack">
                <h3>{% trans "الأسئلة التالية" %}</h3>
                <div class="dropzone" id="routing-targets" aria-label="{% trans 'الأسئلة التالية' %}"></div>
            </div>
        </div>
        <div class="stage-actions">
            <button type="button" class="btn btn-secondary prev-stage" data-prev-stage="final">{% trans "السابق" %}</button>
            <button type="button" class="btn next-stage" data-next-stage="business">{% trans "التالي: قواعد الأعمال" %}</button>
        </div>
    </div>
</section>

<section class="builder-grid stage-panel hidden" data-stage="business" aria-label="{% trans 'قواعد الأعمال' %}">
    <div class="card rules-card">
        <div class="section-head">
            <div>
                <h2 class="card-title">{% trans "قواعد الأعمال" %}</h2>
                <p class="muted">{% trans "حدد شروط العمل والإجراءات الناتجة باستخدام السحب والإفلات." %}</p>
            </div>
        </div>
        <div class="rule-palette" aria-label="{% trans 'الأسئلة المتاحة للقواعد' %}" id="question-palette-business"></div>
        <div class="rules-grid">
            <div class="rule-stack">
                <h3>{% trans "شروط العمل" %}</h3>
                <div class="dropzone" id="business-conditions" aria-label="{% trans 'شروط العمل' %}"></div>
            </div>
            <div class="rule-stack">
                <h3>{% trans "إجراءات العمل" %}</h3>
                <div class="dropzone" id="business-actions" aria-label="{% trans 'إجراءات العمل' %}"></div>
            </div>
        </div>
        <div class="stage-actions">
            <button type="button" class="btn btn-secondary prev-stage" data-prev-stage="routing">{% trans "السابق" %}</button>
        </div>
    </div>
</section>

<template id="section-template">
    <div class="card section-block">
        <div class="section-head">
            <div class="stacked">
                <label>{% trans "عنوان القسم" %}
                    <input type="text" class="section-name">
                </label>
                <label>{% trans "وصف القسم" %}
                    <textarea class="section-description" rows="2"></textarea>
                </label>
            </div>
            <div class="section-controls">
                <button type="button" class="btn btn-secondary remove-section">{% trans "حذف القسم" %}</button>
                <button type="button" class="btn btn-secondary add-question">{% trans "إضافة سؤال" %}</button>
                <button type="button" class="btn btn-secondary add-matrix-question">{% trans "إضافة سؤال مصفوفة" %}</button>
            </div>
        </div>
        <div class="questions-area">
            <div class="question-list"></div>
        </div>
    </div>
</template>

<template id="question-template">
    <div class="card question-block">
        <div class="question-grid">
            <label class="stacked">{% trans "السؤال" %}</label>
            <label class="stacked">{% trans "نوع الاستجابة" %}</label>
            <button type="button" class="btn btn-secondary remove-question">{% trans "حذف" %}</button>

            <select class="question-select" required>
                <option value="" disabled selected>{% trans "اختر سؤالاً من قاعدة البيانات" %}</option>
                {% for q in available_questions %}
                <option value="{{ q.id }}">{{ q.label }}</option>
                {% empty %}
                <option value="" disabled>{% trans "لا توجد أسئلة متاحة بعد" %}</option>
                {% endfor %}
            </select>

            <select class="response-type">
                {% for rt in response_types %}
                <option value="{{ rt.value }}">{{ rt.label }}</option>
                {% endfor %}
            </select>

            <div></div> <!-- Empty cell for alignment -->

            <label class="stacked">{% trans "مجموعة الإجابات" %}</label>
            <label class="checkbox">
                <input type="checkbox" class="question-required">
                <span>{% trans "إلزامي" %}</span>
            </label>
            <div></div> <!-- Empty cell for alignment -->

            <select class="response-group">
                <option value="" disabled selected>{% trans "اختر مجموعة إجابات" %}</option>
                {% for rg in response_groups %}
                <option value="{{ rg.value }}">{{ rg.label }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
</template>

<template id="matrix-question-template">
    <div class="card question-block matrix-question-block">
        <div class="question-grid">
            <label class="stacked">{% trans "أسئلة المصفوفة" %}</label>
            <label class="stacked">{% trans "نوع الاستجابة" %}</label>
            <button type="button" class="btn btn-secondary remove-question">{% trans "حذف" %}</button>

            <select class="matrix-question-select">
                <option value="" disabled selected>{% trans "أضف سؤالاً إلى المصفوفة" %}</option>
                {% for q in available_questions %}
                <option value="{{ q.id }}">{{ q.label }}</option>
                {% endfor %}
            </select>

            <select class="response-type">
                {% for rt in response_types %}
                <option value="{{ rt.value }}">{{ rt.label }}</option>
                {% endfor %}
            </select>

            <div></div> <!-- Empty cell for alignment -->

            <label class="stacked">{% trans "مجموعة المصفوفة" %}</label>
            <label class="checkbox">
                <input type="checkbox" class="question-required">
                <span>{% trans "إلزامي" %}</span>
            </label>
            <div></div> <!-- Empty cell for alignment -->

            <select class="matrix-group">
                <option value="" disabled selected>{% trans "اختر مجموعة مصفوفة" %}</option>
                {% for mg in matrix_item_groups %}
                <option value="{{ mg.value }}">{{ mg.label }}</option>
                {% endfor %}
            </select>

            <div></div> <!-- Empty cell for alignment -->
            <div></div> <!-- Empty cell for alignment -->

            <label class="stacked">{% trans "مجموعة الإجابات" %}</label>
            <div></div> <!-- Empty cell for alignment -->
            <div></div> <!-- Empty cell for alignment -->

            <select class="response-group">
                <option value="" disabled selected>{% trans "اختر مجموعة إجابات" %}</option>
                {% for rg in response_groups %}
                <option value="{{ rg.value }}">{{ rg.label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="selected-matrix-questions mt-2"></div>
    </div>
</template>

{{ response_types|json_script:"response-types-data" }}
{{ available_questions|json_script:"available-questions-data" }}
{{ response_groups|json_script:"response-groups-data" }}
{{ matrix_item_groups|json_script:"matrix-item-groups-data" }}
{{ survey_structures|json_script:"survey-structures-data" }}
<script id="builder-locale" type="application/json">
    {
        "yes": "{% trans 'نعم' %}",
        "no": "{% trans 'لا' %}",
        "untitled": "{% trans 'استبيان بدون عنوان' %}",
        "manual": "{% trans 'يدوي' %}",
        "bank": "{% trans 'بنك الأسئلة' %}",
        "emptyColumn": "{% trans 'لا توجد عناصر في هذا العمود بعد' %}",
        "emptyScoring": "{% trans 'لا توجد عناصر بانتظار التسجيل.' %}",
        "markReviewed": "{% trans 'تمت المراجعة' %}",
        "reviewed": "{% trans 'مُراجع' %}",
        "routingConditions": "{% trans 'اسحب شروط التوجيه هنا' %}",
        "routingTargets": "{% trans 'ضع الأسئلة التالية هنا' %}",
        "businessConditions": "{% trans 'اسحب شروط الأعمال هنا' %}",
        "businessActions": "{% trans 'ضع الإجراءات هنا' %}"
    }
</script>
{% endblock %}

{% block extra_js %}
<script src="{% static 'surveys/js/builder.js' %}"></script>
{% endblock %}
