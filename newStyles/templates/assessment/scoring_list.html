{% extends 'assessment/base.html' %}

{% block head_extra %}
<style>
    .status-dot {
        width: 0.5rem;
        height: 0.5rem;
        border-radius: 9999px;
    }
    .status-completed { background-color: #10b981; }
    .status-current { background-color: #3b82f6; }
    .status-pending { background-color: #6b7280; }
    .status-na { background-color: #cbd5e1; }

    .step-pill {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.375rem 0.75rem;
        border-radius: 9999px;
        border-width: 1px;
        font-size: 0.875rem;
        font-weight: 500;
        box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        white-space: normal;
        text-align: center;
        max-width: 12rem;
        min-height: 2.5rem;
    }
    .pill-completed { background-color: #ecfdf5; color: #065f46; border-color: #a7f3d0; }
    .pill-current { background-color: #eff6ff; color: #1e40af; border-color: #bfdbfe; ring-width: 2px; ring-color: #dbeafe; }
    .pill-pending { background-color: #f8fafc; color: #475569; border-color: #e2e8f0; cursor: not-allowed; }
    .pill-na { background-color: #f1f5f9; color: #94a3b8; border-color: #e2e8f0; cursor: not-allowed; }


    .connector-line {
        width: 2rem;
        height: 2px;
        background-color: #cbd5e1;
        margin: 0 0.75rem;
    }
    .dark .connector-line {
        background-color: #475569;
    }
</style>
{% endblock %}

{% block content %}
<div class="w-full max-w-5xl mx-auto text-right">

    <div class="mb-8">
        <h1 class="text-3xl font-bold">لوحة تحكم التصنيف</h1>
        <p class="text-lg mt-2">تتبع تقدم كل استبيان عبر مراحل المراجعة.</p>
    </div>

    <div class="space-y-4">
        {% for survey in surveys %}
        <div class="box rounded-lg shadow-md overflow-hidden">
            <div class="p-4">
                <h2 class="text-xl font-bold">{{ survey.name }}</h2>
            </div>
            <div class="border-t border-gray-200 dark:border-gray-700 p-4 space-y-4">
                {% for version in survey.versions.all %}
                <div class="border-b border-gray-200 dark:border-gray-700 last:border-b-0 pb-4 last:pb-0">
                    <h3 class="text-lg font-semibold mb-3">{{ version.version_date|date:"Y-m-d" }}</h3>
                    <div class="flex items-center flex-wrap">
                        {% with step=version.flow.stepsBeforeBranch.0 %}
                            {% if step.url %}<a href="{{ step.url }}">{% else %}<div class="cursor-not-allowed">{% endif %}
                                <div class="step-pill pill-{{ step.status }}">
                                    <span class="status-dot status-{{ step.status }}"></span>
                                    <span>{{ step.label }}</span>
                                </div>
                            {% if step.url %}</a>{% else %}</div>{% endif %}
                        {% endwith %}

                        <div class="connector-line"></div>

                        <div class="flex flex-col items-start gap-2">
                            {% for step in version.flow.branchSteps %}
                                {% if step.url %}<a href="{{ step.url }}">{% else %}<div class="cursor-not-allowed">{% endif %}
                                    <div class="step-pill pill-{{ step.status }}">
                                        <span class="status-dot status-{{ step.status }}"></span>
                                        <span>{{ step.label }}</span>
                                    </div>
                                {% if step.url %}</a>{% else %}</div>{% endif %}
                            {% endfor %}
                        </div>

                        <div class="connector-line"></div>

                        {% for step in version.flow.stepsAfterBranch %}
                        <div class="flex items-center">
                            {% if step.url %}<a href="{{ step.url }}">{% else %}<div class="cursor-not-allowed">{% endif %}
                                <div class="step-pill pill-{{ step.status }}">
                                    <span class="status-dot status-{{ step.status }}"></span>
                                    <span>{{ step.label }}</span>
                                </div>
                            {% if step.url %}</a>{% else %}</div>{% endif %}
                            {% if not forloop.last %}<div class="connector-line"></div>{% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% empty %}
        <div class="box rounded-lg shadow-md p-4 text-center">
            <p>لا توجد استبيانات متاحة.</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
